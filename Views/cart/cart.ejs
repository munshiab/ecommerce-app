<script>
  console.log('JavaScript loaded for cart page');
  // Remove item from cart
  async function removeFromCart(productId) {
  console.log(`Remove button clicked for product ID: ${productId}`); // Debugging log

  if (!productId) {
    console.error('Invalid product ID');
    return;
  }

  try {
    const response = await fetch('/cart/remove', { // Ensure the URL matches your backend route
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ product_id: productId }),
    });

    if (!response.ok) {
      console.error('Failed to remove item:', response.statusText);
      return;
    }

    const data = await response.json();
    console.log('Remove response:', data); // Debugging log

    if (data.success) {
      M.toast({ html: data.message, classes: 'green darken-1' });
      location.reload(); // Reload the cart page
    } else {
      M.toast({ html: 'Error removing item', classes: 'red darken-1' });
    }
  } catch (error) {
    console.error('Error removing item:', error);
  }
}

  // Update cart quantity
  async function updateQuantity(productId, quantity) {
  try {
    console.log(`Updating product ${productId} to quantity ${quantity}`); // Debug log
    const response = await fetch('/cart/update-quantity', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ product_id: productId, quantity }),
    });

    const data = await response.json();
    console.log('Update quantity response:', data); // Debug log

    if (data.success) {
      M.toast({ html: data.message, classes: 'green darken-1' });
      location.reload(); // Reload the cart page
    } else {
      M.toast({ html: 'Error updating quantity', classes: 'red darken-1' });
    }
  } catch (error) {
    console.error('Error updating quantity:', error);
  }
}

</script>

<div class="container">
  <h3 class="center-align">Your Cart</h3>

  <% if (cartItems.length === 0) { %>
    <p class="center-align">Your cart is empty. Start adding some products!</p>
  <% } else { %>
    <table class="highlight responsive-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% cartItems.forEach(item => { %>
          <tr>
            <td><%= item.product_name %></td>
            <td>$<%= (parseFloat(item.price) || 0).toFixed(2) %></td>
            <td>
              <input 
                type="number" 
                value="<%= item.quantity %>" 
                min="1" 
                onchange="updateQuantity('<%= item.product_id %>', this.value)"
              />
            </td>
            <td>$<%= (parseFloat(item.total_price) || 0).toFixed(2) %></td>
            <td>
              <button 
                class="btn red" 
                onclick="removeFromCart('<%= item.product_id %>')"
              >
                Remove
              </button>
            </td>                                           
          </tr>
        <% }) %>
      </tbody>
    </table>

    <div class="right-align">
      <h5>Total: $<%= (parseFloat(cartItems.reduce((sum, item) => sum + item.total_price, 0))).toFixed(2) %></h5>
    </div>

    <div class="center-align">
      <a href="/checkout" class="btn waves-effect waves-light">Proceed to Checkout</a>
    </div>
  <% } %>
</div>


<!-- <div class="container">
  <h3 class="center-align">Your Cart</h3>

  <% if (cartItems.length === 0) { %>
    <p class="center-align">Your cart is empty. Start adding some products!</p>
  <% } else { %>
    <table class="highlight responsive-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <% cartItems.forEach(item => { %>
          <tr>
            <td><%= item.product_name %></td>
            <td>$<%= (parseFloat(item.price) || 0).toFixed(2) %></td>
            <td><%= item.quantity %></td>
            <td>$<%= (parseFloat(item.total_price) || 0).toFixed(2) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <div class="right-align">
      <h5>Total: $<%= (parseFloat(cartItems.reduce((sum, item) => sum + item.total_price, 0))).toFixed(2) %></h5>
    </div>

    <div class="center-align">
      <a href="/checkout" class="btn waves-effect waves-light">Proceed to Checkout</a>
    </div>
  <% } %>
</div>
 -->