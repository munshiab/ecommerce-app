<div class="container">
  <h3 class="center-align">Your Cart</h3>

  <% if (cartItems.length === 0) { %>
    <p class="center-align">Your cart is empty. Start adding some products!</p>
  <% } else { %>
    <table class="highlight responsive-table">
      <thead>
        <tr>
          <th>Image</th>
          <th>Product</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% cartItems.forEach(item => { %>
          <tr>
            <td>
              <img 
                src="<%= item.image_url %>" 
                alt="<%= item.product_name %>" 
                style="width: 50px; height: 50px; object-fit: cover;"
              >
            </td>
            <td><%= item.product_name %></td>
            <td>$<%= (parseFloat(item.price) || 0).toFixed(2) %></td>
            <td>
              <input 
                type="number" 
                min="1" 
                value="<%= item.quantity %>" 
                data-product-id="<%= item.product_id %>" 
                onchange="updateQuantity(this)"
                style="width: 60px;"
              >
            </td>
            <td>$<%= (parseFloat(item.total_price) || 0).toFixed(2) %></td>
            <td>
              <button 
                class="btn red lighten-1" 
                onclick="removeFromCart('<%= item.product_id %>')"
              >
                Remove
              </button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <div class="right-align">
      <h5>Total: $<%= totalAmount %></h5>
    </div>

    <div class="center-align">
      <a href="/checkout" class="btn waves-effect waves-light">Proceed to Checkout</a>
    </div>
  <% } %>
</div>


<script>
  // Handle updating cart quantity
  async function updateCartQuantity(productId, quantity) {
    if (quantity < 1) {
      M.toast({ html: 'Quantity must be at least 1', classes: 'red darken-1' });
      return;
    }

    try {
      const response = await fetch('/cart/update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ product_id: productId, quantity: quantity }),
      });

      const data = await response.json();
      if (data.success) {
        M.toast({ html: 'Cart updated successfully!', classes: 'green darken-1' });
        location.reload(); // Reload the cart page
      } else {
        M.toast({ html: 'Error updating cart', classes: 'red darken-1' });
      }
    } catch (error) {
      console.error('Error updating cart:', error);
    }
  }

  // Handle removing items from cart
  async function removeFromCart(productId) {
    try {
      const response = await fetch('/cart/remove', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ product_id: productId }),
      });

      const data = await response.json();
      if (data.success) {
        M.toast({ html: 'Item removed from cart!', classes: 'green darken-1' });
        location.reload(); // Reload the cart page
      } else {
        M.toast({ html: 'Error removing item', classes: 'red darken-1' });
      }
    } catch (error) {
      console.error('Error removing item:', error);
    }
  }
</script>
